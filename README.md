# wsChatAPI
API для написания своих клиентов к чату (https://sinair.ru/chat/)

## Установка
```
npm install https://github.com/iassasin/wschatapi.git
```

## Использование
После установки модуля, его использование в проекте аналогично другим:
```javascript
const WsChat = require('wschatapi');
```
Первым делом нужно создать подключение, затем назначить коллбеки и установить соединение.

Ниже приведен пример простого подключения и отправки сообщения:
```javascript
let chat = new WsChat('wss://sinair.ru/ws/chat');
chat.onOpen = function(){
	chat.joinRoom('#test', (success, room) => {
		room.sendMessage('/nick testbot');
		room.sendMessage('Привет, я бот!');
		chat.close();
	});
};

chat.open();
```
## Работа с API
В API используются два класса, доступные пользователю:
* `WsChat` - основной класс подключения и обработки событий;
* `Room` - класс подключения к конкретной комнате, его нельзя инстанцировать вручную, но к нему появляется доступ после подключения к комнате.

### wsChat
Представляет собой набор управляющих методов и событий.

Каждый коллбек первым аргументом получает `success` - булевое значение, означающее, успешно ли завершилась операция. В случае, если `success` принимает значение `false`, вторым аргументом всегда будет объект, описывающий ошибку.

Часть методов могут иметь коллбэки, которые (если заданы) перекрывают аналогичные глобальные обработчики событий. Чтобы глобальный обработчик вызывался в любом случае, необходимо из коллбэка вернуть значение `true`. Например:
```javascript
chat.onJoinedRoom = function(room){ /* ... */ };
chat.joinRoom('#chat', function(success, room){
	// ...
	return true;
});
```

#### Методы  
Ниже будет встречаться параметр `room` - объект класса `Room`.

* `wsChat(address)` - конструктор класса, `address` - адрес websocket-сервера чата, например `wss://sinair.ru/ws/chat`;
* `open()` - установить соединение с сервером;
* `close()` - закрыть соединение с сервером;
* `authByKey(key, callback(success, userinfo))` - выполнить авторизацию на сервере с помощью временного ключа (получается только через сайт авторизованными пользователями);
* `authByApiKey(key, callback(success, userinfo))` - выполнить авторизацию на сервере с помощью постоянного API-ключа (получается только посредством связи с администратором чата);
* `changeStatus(status)` - изменить свой статус. Допустимы только значения `UserStatus.away` и `UserStatus.back`;
* `joinRoom(target, callback(success, room))` или `joinRoom(options)` - присоединиться к комнате `target`. Также можно передать вместо аргументов объект опций. Опции по умолчанию следующие:

```
{
	target: '',
	callback: null,
	autoLogin: false, // Автоматически войти в комнату с ником, который использовался в ней ранее (для авторизированных пользователей)
	loadHistory: false, // Загрузить последние 50 сообщений в комнате
}
```
* `leaveRoom(target, callback(success, room))` - покинуть комнату `target`;
* `createRoom(target, callback(success))` - создать комнату с именем `target`;
* `removeRoom(target, callback(success))` - удалить свою комнату с именем `target`;
* `getConnectedRooms()` - получить список комнат, к которым были осуществлены подключения;
* `getRoomByTarget(target)` - найти комнату с именем `target` в списке подключенных.

#### События
* `onOpen()` - вызывается после подключения к серверу;
* `onClose()` - вызывается после отключения от сервера;
* `onConnectionError(error)` - вызывается при возникновении ошибки подключения;
* `onError(error)` - вызывается для необработанных ошибок при работе с API;
* `onJoinedRoom(room)` - вызывается после подключения к комнате;
* `onLeaveRoom(room)` - вызывается после отключения от комнаты;
* `onRoomCreated(target)` - вызывается после успешного создания комнаты `target`;
* `onRoomRemoved(target)` - вызывается после успешного удаления комнаты `target`;
* `onMessage(room, msgobj)` - вызывается при получении нового сообщения в комнате `room`;
* `onSysMessage(room, text)` - вызывается при получении системного сообщения. Когда сообщение не относится ни к одной комнате, `room` принимает значение `null`;
* `onUserStatusChanged(room, userobj)` - вызывается при изменении статуса подключенного к комнате пользователя ();
* `onUserConnected(room, userobj)` - вызывается при подключении пользователя к комнате;
* `onUserDisconnected(room, userobj)` - вызывается при отключении пользователя от комнаты.

`msgobj` и `userobj` - объекты, возвращаемые при событии, и описаны ниже.

### Room
Класс, предоставляющий набор методов и событий для конкретной комнаты. События по описанию аналогичны глобальным, поэтому могут не описываются повторно.

#### Методы
* `sendMessage(text)` - отправить сообщение в комнату;
* `changeStatus(status)` - изменить свой статус. Допустимы только следующие значения `UserStatus`: `away`, `back`, `typing`, `stop_typing`;
* `getTarget()` - получить имя текущей комнаты;
* `getMembers()` - получить список пользователей в текущей комнате;
* `getMemberById(id)` - получить информацию о пользователе по его внутрикомнатному ID;
* `getMyMemberId()` - получить свой внутрикомнатный ID;
* `getMyMemberNick()` - получить свой текущий никнейм в комнате;

#### События
* `onError(err)` - вызывается для необработанных ошибок при работе с API;
* `onSysMessage(message)` - вызывается при получении системного сообщения;
* `onMessage(msgobj)` - вызывается при получении нового сообщения в комнате;
* `onUserStatusChanged(user)` - вызывается при изменении статуса того, или иного пользователя в комнате;
* `onUserConnected(user)` - вызывается при подключении пользователя к комнате;
* `onUserDisconnected(user)` - вызывается при отключении пользователя от комнаты;
* `onJoined()` - вызывается после подключения к комнате;
* `onLeave()` - вызывается после отключения от комнаты;

### Типы статуса, сообщения, ошибки и пакета
Ниже перечислены типы статуса пользователя, сообщения, ошибки и пакета. Они так же могут иметь аналогичную нумерацию, начиная с нуля:

#### Тип статуса пользователя (UserStatus)
* `bad` - если вы получили такой статус, что-то точно пошло не так;
* `offline` - пользователь отключился;
* `online` - пользователь онлайн;
* `away` - пользователь отошел;
* `nick_change` - пользователь изменил никнейм;
* `gender_change` - пользователь сменил пол;
* `color_change` - пользователь изменил цвет никнейма;
* `back` - пользователь вернулся (после статуса `away`);
* `typing` - пользователь начал набирать сообщение;
* `stop_typing` - пользователь прекратил набирать сообщение.

#### Тип сообщения (MessageStyle)
* `message` - обычное сообщение;
* `me` - сообщение-действие от своего лица;
* `event` - сообщение от третьего лица;
* `offtop` - оффтоп-сообщение (выходящее за рамки текущего обсуждения).

#### Тип ошибки (ErrorCode)
* `unknown` - неизвестная ошибка;
* `database_error` - ошибка соединения с базой данных;
* `already_connected` - вы уже подключены (например, к комнате);
* `not_found` - цель запроса не была найдена (например, комната с таким названием)
* `access_denied` - доступ запрещен;
* `invalid_target` - неверно задано имя комнаты;
* `already_exists` - цель запроса уже существует (например, комната с таким названием).

#### Тип пакета (PackType)
* `error` - сообщение об ошибке;
* `system` - системное сообщение;
* `message` - сообщение;
* `online_list` - запрос списка онлайна;
* `auth` - запрос авторизации;
* `status` - запрос информации о пользователе;
* `join` - запрос на подключение к комнате;
* `leave` - запрос на отключение от комнаты;
* `create_room` - запрос на создание комнаты;
* `remove_room` - запрос на удаление комнаты;
* `ping` - служебный пакет для проверки связи.

### Объекты и массивы объектов
Ниже описано содержание объектов и массивов объектов, возвращаемых некоторыми событиями и методами.

Объект сообщения `msgobj`, передаваемый обработчиком события `onMessage()` содержит в себе следующие свойства:

* `color` - цвет никнейма отправителя сообщения;
* `from` - внутрикомнатный ID отправителя сообщения;
* `from_login` - никнейм отправителя сообщения;
* `message` - содержимое сообщения;
* `style` - тип сообщения;
* `target` - название комнаты, в которую было отправлено сообщение;
* `time` - время отправки сообщения;
* `to` - внутрикомнатный ID получателя сообщения (0, если сообщение не личное);

Объект информации о пользователе `user` или `userobj`, передаваемый обработчиком событий `onUserStatusChanged()`, `onUserConnected()`, `onUserDisconnected()` или возвращаемый методом `getMemberById()`, а так же в объекте массива, возвращаемого методом `getMembers()` содержит в себе следующие свойства:

* `color` - цвет никнейма пользователя;
* `data` - данные события (например, при смене никнейма принимает значение предыдущего никнейма пользователя);
* `girl` - пользователь имеет женский пол;
* `is_moder` - пользователь является модератором комнаты;
* `is_owner` - пользователь создатель комнаты;
* `member_id` - внутрикомнатный ID пользователя;
* `name` - никнейм пользователя;
* `status` - статус пользователя;
* `target` - название комнаты, в которой произошло событие;
* `user_id` - ID пользователя (0, если пользователь не авторизирован);
